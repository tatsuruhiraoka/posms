import mlflow
import xgboost as xgb
import pandas as pd

from posms.model.registered_plus.tuner import get_best_params
from posms.model.registered_plus.metrics import calc_metrics


TARGET = "registered_plus"  # 書留＋LP+ の合算列名（後で特徴量生成時に作る）


def train(df_train: pd.DataFrame, df_valid: pd.DataFrame):
    """書留＋LP+モデルの学習"""

    X_train = df_train.drop(columns=[TARGET])
    y_train = df_train[TARGET]

    X_valid = df_valid.drop(columns=[TARGET])
    y_valid = df_valid[TARGET]

    # Optuna などからベストパラメタ取得
    best_params = get_best_params()

    with mlflow.start_run(run_name="posms-registered_plus"):
        model = xgb.XGBRegressor(
            **best_params,
            objective="reg:squarederror",
            n_jobs=-1,
        )

        model.fit(
            X_train,
            y_train,
            eval_set=[(X_valid, y_valid)],
            verbose=False,
        )

        # ---------------------------
        # MLflow ログ
        # ---------------------------
        mlflow.log_params(best_params)

        mae, rmse = calc_metrics(model, X_valid, y_valid)
        mlflow.log_metric("mae", mae)
        mlflow.log_metric("rmse", rmse)

        mlflow.xgboost.log_model(model, artifact_path="model")

        return model
