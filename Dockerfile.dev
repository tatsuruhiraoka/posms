# syntax=docker/dockerfile:1.6
FROM python:3.11-slim

ENV PIP_DISABLE_PIP_VERSION_CHECK=1 \
    PIP_PREFER_BINARY=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1

# ランタイムに必要なOS依存（xgboost/scikitのOpenMP, psycopg2ランタイム, お好みでcurl）
RUN apt-get update && \
    apt-get install -y --no-install-recommends libgomp1 libpq5 curl && \
    rm -rf /var/lib/apt/lists/*

WORKDIR /app

# 依存のキャッシュを効かせるため、まずメタデータだけコピー
COPY pyproject.toml README.md LICENSE /app/

# 依存を導入（開発中は -e . へ続けて切り替える）
RUN --mount=type=cache,target=/root/.cache/pip \
    pip install --no-cache-dir .

# ソースを後段でコピー（ここから先がよく変わる）
COPY posms /app/posms

# 開発向け：編集即反映（本番はこの行を削除して通常インストールのみでOK）
RUN --mount=type=cache,target=/root/.cache/pip \
    pip install --no-cache-dir -e .

# CMD は compose 側で上書きする想定。とりあえずヘルプ表示
CMD ["posms", "--help"]
